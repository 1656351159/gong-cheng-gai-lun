{% extends 'base.html' %}
{% block content %}
{% set col_span = 9 if current_user.role in ['technician', 'admin'] else 8 %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">领用记录</h4>
  {% if current_user.role == 'admin' %}
  <a class="btn btn-outline-primary" href="{{ url_for('main.export_requests') }}">导出申请 CSV</a>
  {% endif %}
</div>
<div class="table-responsive">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>材料</th>
        <th>数量</th>
        <th>申请人</th>
        <th>用途</th>
        <th>课程/项目</th>
        <th>状态</th>
        <th>时间</th>
        {% if current_user.role in ['technician', 'admin'] %}
        <th>操作</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for req in requests %}
      <tr>
        <td>{{ req.id }}</td>
        <td>{{ req.material.name }}</td>
        <td>{{ req.quantity }}</td>
        <td>{{ req.requester.username }}</td>
        <td>{{ req.purpose }}</td>
        <td>{{ req.course_code }}</td>
        <td>
          {% if req.status == 'pending' %}
          <span class="badge bg-warning text-dark">待审核</span>
          {% elif req.status == 'approved' %}
          <span class="badge bg-success">已通过</span>
          {% else %}
          <span class="badge bg-danger">已驳回</span>
          {% endif %}
        </td>
        <td>{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        {% if current_user.role in ['technician', 'admin'] %}
        <td>
          {% if req.status == 'pending' %}
          <form class="d-inline" method="post" action="{{ url_for('main.approve_request', request_id=req.id) }}">
            <button class="btn btn-sm btn-success" type="submit">通过</button>
          </form>
          <form class="d-inline" method="post" action="{{ url_for('main.reject_request', request_id=req.id) }}">
            <input type="hidden" name="reason" value="库存不足">
            <button class="btn btn-sm btn-outline-danger" type="submit">驳回</button>
          </form>
          {% endif %}
        </td>
        {% endif %}
      </tr>
      {% else %}
      <tr><td colspan="{{ col_span }}" class="text-center">暂无数据</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
